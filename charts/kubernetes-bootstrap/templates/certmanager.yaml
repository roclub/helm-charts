{{- if .Values.certManager.enabled -}}
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: '{{ .Values.applicationPrefix }}-cert-manager'
  namespace: argocd
spec:
    project: {{ .Values.project }}
    source:
        {{- with .Values.certManager }}
        repoURL: https://charts.jetstack.io
        targetRevision: {{ .targetRevision }}
        chart: cert-manager
        {{- end }}
        helm:
            releaseName: {{ .Values.releaseNamePrefix }}-cert-manager
            values: |
            {{- with .Values.certManager }}
              global:
                logLevel: 2

                leaderElection:
                  namespace: "kube-system"

              installCRDs: true

              podDnsPolicy: {{ .podDnsPolicy }}
              {{- if .podDnsConfig }}
              podDnsConfig:
                nameservers:
                {{- range .podDnsConfig.nameservers }}
                - {{ . | quote }}
                {{- end }}              
              {{- end }}

              featureGates: ""
              maxConcurrentChallenges: 60
              clusterResourceNamespace: ""
              namespace: ""

              ingressShim: {}

              prometheus:
                enabled: false

              webhook:
                replicaCount: 1
                timeoutSeconds: 10

              cainjector:
                enabled: true
              startupapicheck:
                enabled: true

        {{- end }}
    destination:
        name: {{ .Values.cluster }}
        {{- with .Values.certManager }}
        namespace: {{ .namespace }}
        {{- end }}
    syncPolicy:
        automated:
            prune: true
            selfHeal: true
            allowEmpty: false

        syncOptions:
            - Validate=true
            - CreateNamespace=true
            - PrunePropagationPolicy=foreground
            - PruneLast=true 

        retry:
            limit: 3
            backoff:
                duration: 10s
                factor: 2
                maxDuration: 3m
{{- end }}